<!DOCTYPE html>
<html>
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="manifest" href="/circuit/manifest.json">
  
    <!-- 登录验证脚本 -->
    <script>
      // 检查用户是否已登录
      if (sessionStorage.getItem('authenticated') !== 'true') {
        // 记录当前页面URL，以便登录后返回
        sessionStorage.setItem('redirect_after_login', window.location.href);
        // 未登录，重定向到登录页
        window.location.href = 'login.html';
      }
    </script>
  
    <!-- Properties can be specified to influence deferred binding -->
    <meta name='gwt:property' content='locale=en_UK'>
    
    <!-- 添加对话框相关CSS -->
    <style>
    /* 对话框动画 */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { transform: translate(-50%, -60%); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }

    /* 全局对话框样式 */
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      animation: fadeIn 0.3s ease;
    }

    .dialog-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      z-index: 9999;
      width: 400px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideIn 0.3s ease;
    }

    .dialog-btn {
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .dialog-btn-primary {
      background-color: #5e35b1;
      color: white;
      border: none;
    }

    .dialog-btn-secondary {
      background-color: #f5f5f5;
      border: 1px solid #ccc;
    }

    .project-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .project-item:hover {
      background-color: #f8f0ff;
    }

    .project-item.selected {
      background-color: #f0e6ff;
    }

    /* 定义旋转动画 */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    </style>
    
    
    <!-- Titles are optional, but useful -->
    <title></title>

<style>
.disabled {
	color: lightgray
}
.topSpace {
	margin-top: 12px;
}
.cursorPointer {
   cursor: default;
}
.cursorCross {
   cursor: crosshair;
}

.cursorSplitter {
   cursor: row-resize;
}

/* 去掉Canvas的焦点边框 */
canvas, canvas:focus, canvas:active {
   outline: none !important;
   -webkit-tap-highlight-color: rgba(0,0,0,0);
   -webkit-focus-ring-color: rgba(0,0,0,0);
   border: none !important;
   box-shadow: none !important;
}

.gwt-MenuItem-disabled {
	color: lightgray;
  /* color: rgb(11, 133, 219); */

}
.offScreen {
	position: absolute;
	right: 101%;
	overflow: hidden;
}
.gwt-Frame{
	overflow: hidden;
	border: 0px !important;
}

.gwt-MenuItem {
	font-size: 14px !important;
}

.gwt-MenuBar-horizontal {
	font-size: 14px !important;
	}
	
.gwt-Label-selected {
	font-size: 1.3em;
	font-weight: 700;
	border-top: 1px solid black;
	border-bottom: 1px solid black;
}
.gwt-Label-1off {
	color: DarkGray;
}

.gwt-Label-2off {
	font-size:0.8em;
	color: LightGray;
}

.gwt-Label-current {
}

.gwt-Button.chbut {
	padding:3px;
	margin: 3px;
}

.gwt-Button.chbut.chsel {
	font-weight: bold;
}

.gwt-Button.chbut-black {
	background: black;
	color: white;
}

.gwt-Button.chbut-white {
	background: white;
	color: black;
}

.gwt-TextBox.scalebox {
	width: 100px;
}

.gwt-Button.expand-but {
	line-height: 0;
	font-size: 13px;
	margin-right: 5px;
	border-radius:0px;
	display: inline-block;
	text-align: center;
	width: 15px;
	height: 15px;
	padding-left: 0;
	padding-right: 0;
	padding-bottom:1px;
	padding-top:0;
	margin-bottom:1px;
	background:gray;
	color:white;
}


.topButton-red {
    margin-top: 5px;
    margin-bottom: 5px;
    margin-left:5px;
    padding: 5px 7px;
    text-decoration: none;
    color: #ffffff;
    cursor: pointer;
    cursor: hand;
    font-size: small;
    background-color: #ff0000; 
    border: 1px solid #bbb;
    border-bottom: 1px solid #a0a0a0;
    border-radius: 3px;
    -moz-border-radius: 3px;
}

.topButton {
    margin-top: 5px;
    margin-bottom: 5px;
    margin-left: auto;
    margin-right: auto;
    padding: 5px 7px;
    text-decoration: none;
    cursor: pointer;
    cursor: hand;
    font-size: small;
    background-color: #e7e7e7; 
    border: 1px solid #bbb;
    border-bottom: 1px solid #a0a0a0;
    border-radius: 3px;
    -moz-border-radius: 3px;
    display: block;
    text-align: center;
}

.radioPanel label {
	margin-right: 15px;
}

</style>

<link rel="stylesheet" href="font/fontello.css">

</head>
  <body>
  <!-- 添加顶部按钮和下拉菜单 -->
  <div style="position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; gap: 15px;">
    <!-- 项目按钮 -->
    <div class="dropdown">
      <button id="projectBtn" class="dropbtn" style="background-color: #5e35b1; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 10px;">
        <img src="img/svg/folder-open.svg" alt="项目" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
        <span>项目</span>
      </button>
      <div id="projectDropdown" class="dropdown-content">
        <a href="#" id="saveToCloudBtn">保存到云端</a>
        <a href="myCircuits.html">我的项目</a>
  </div>
    </div>
    
    <!-- 个人中心按钮 -->
    <div class="dropdown">
      <button id="userCenterBtn" class="dropbtn" style="background-color: #5e35b1; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 10px;">
        <img src="img/svg/user-avatar.svg" alt="用户" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
        <span>个人中心</span>
      </button>
      <div id="userDropdown" class="dropdown-content">
        <a href="userProfile.html">我的资料</a>
        <a href="myCircuits.html">我的项目</a>
        <a href="logout.html">退出登录</a>
      </div>
    </div>
  </div>

  <style>
    /* 下拉菜单样式 */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      margin-top: 8px;
      background-color: rgba(255, 255, 255, 0.8); /* 半透明背景 */
      backdrop-filter: blur(8px); /* 磨砂效果 */
      -webkit-backdrop-filter: blur(8px); /* Safari 兼容 */
      width: 100%; /* 与按钮宽度一致 */
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
      z-index: 1;
      border-radius: 16px; /* 大圆角 */
      overflow: hidden; /* 确保内容不溢出圆角 */
      border: 1px solid rgba(255, 255, 255, 0.2); /* 细微边框增强立体感 */
    }

    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: center; /* 水平居中 */
      transition: all 0.2s ease; /* 平滑过渡效果 */
      font-size: 15px; /* 加大字号 */
      font-weight: 500; /* 适度加粗 */
    }

    .dropdown-content a:hover {
      background-color: rgba(94, 53, 177, 0.1); /* 与按钮颜色协调的hover效果 */
    }

    .show {
      display: block;
    }
  </style>

  <script>
    // 全局变量，用于保存从GWT应用获取的电路数据
    var circuitTextData = null;
    
    // 用于接收GWT应用发送的电路文本数据的回调函数
    function receiveCircuitText(text) {
      console.log("接收到电路文本数据，长度: " + (text ? text.length : 0));
      circuitTextData = text;
    }
    
    // 顶部菜单功能
    document.addEventListener('DOMContentLoaded', function() {
      console.log("文档已加载，开始初始化顶部菜单");
      
      // 检查是否有来自登录页面的待保存电路数据
      const circuitToSave = sessionStorage.getItem('circuit_to_save');
      if (circuitToSave) {
        console.log("检测到登录后需要保存的电路数据");
        sessionStorage.removeItem('circuit_to_save');
        
        // 等待页面和API完全加载
        setTimeout(() => {
          // 确保用户已登录
          const userId = localStorage.getItem('userId');
          const token = localStorage.getItem('eda_token');
          
          if (userId && token) {
            console.log("用户已登录，自动触发保存流程");
            window.currentCircuitData = circuitToSave;
            showGWTProjectSaveDialog();
            showProjectMenu();
          }
        }, 2000);
      }
      
      // 检查保存按钮是否存在
      const saveBtn = document.getElementById('saveToCloudBtn');
      if (saveBtn) {
        console.log("找到保存到云端按钮，绑定点击事件");
      } else {
        console.error("未找到保存到云端按钮，请检查HTML结构");
      }
      
      // 个人中心按钮下拉菜单
      document.getElementById('userCenterBtn').addEventListener('click', function(e) {
        e.preventDefault();
        // 关闭其他下拉菜单
        document.getElementById('projectDropdown').classList.remove('show');
        // 切换当前下拉菜单显示状态
        document.getElementById('userDropdown').classList.toggle('show');
      });
      
      // 项目按钮下拉菜单
      document.getElementById('projectBtn').addEventListener('click', function(e) {
        e.preventDefault();
        // 关闭其他下拉菜单
        document.getElementById('userDropdown').classList.remove('show');
        // 切换当前下拉菜单显示状态
        document.getElementById('projectDropdown').classList.toggle('show');
      });
      
      // 保存到云端功能
      document.getElementById('saveToCloudBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        console.log("保存到云端按钮被点击");
        
        // 隐藏下拉菜单
        document.getElementById('projectDropdown').classList.remove('show');
        
        // 检查是否已登录
        const userId = localStorage.getItem('userId');
        const token = localStorage.getItem('eda_token');
        
        // 验证用户登录状态
        if (!userId || !token) {
          console.log("未找到用户信息或令牌，需要登录");
          showLoginRequiredDialog();
          return;
        }
        
        // 主动尝试刷新令牌，然后再进行保存操作
        console.log("主动尝试刷新令牌");
        
        // 检查是否有保存的登录信息
        const savedUsername = localStorage.getItem('saved_username');
        const savedPassword = localStorage.getItem('saved_password');
        
        if (savedUsername && savedPassword) {
          try {
            // 解码密码
            const decodedPassword = atob(savedPassword);
            
            // 尝试自动重新登录以刷新令牌
            API.login({
              username: savedUsername,
              password: decodedPassword,
              rememberMe: true
            })
            .then(loginResponse => {
              console.log("自动刷新令牌结果:", loginResponse);
              if (loginResponse.code === 200) {
                // 刷新令牌成功，继续保存操作
                console.log("令牌刷新成功，继续保存操作");
                getAndSaveCircuitDataGWT();
              } else {
                console.log("自动登录失败，尝试使用当前令牌");
                // 尝试使用当前令牌验证
                validateTokenAndSave();
              }
            })
            .catch(loginError => {
              console.error("自动登录失败:", loginError);
              // 尝试使用当前令牌验证
              validateTokenAndSave();
            });
          } catch (decodeError) {
            console.error("解码密码失败:", decodeError);
            // 尝试使用当前令牌验证
            validateTokenAndSave();
          }
        } else {
          // 无法自动登录，尝试使用当前令牌验证
          console.log("没有保存的登录信息，尝试使用当前令牌");
          validateTokenAndSave();
        }
        
        // 使用当前令牌进行验证
        function validateTokenAndSave() {
          API.validateToken()
            .then(response => {
              console.log("验证令牌结果:", response);
              if (response.code === 200) {
                // 令牌有效，继续保存操作
                getAndSaveCircuitDataGWT();
              } else {
                console.log("令牌无效，提示用户重新登录");
                showLoginRequiredDialog();
              }
            })
            .catch(error => {
              console.error("验证令牌失败:", error);
              showLoginRequiredDialog();
            });
        }
      });

      // 点击页面其他地方时关闭所有下拉菜单
      window.addEventListener('click', function(e) {
        const userCenterBtn = document.getElementById('userCenterBtn');
        const projectBtn = document.getElementById('projectBtn');
        
        // 如果点击的是按钮或其子元素，不做任何操作
        if (userCenterBtn.contains(e.target) || projectBtn.contains(e.target)) {
          return;
        }
        
        // 否则，隐藏所有下拉菜单
        var userDropdown = document.getElementById('userDropdown');
        var projectDropdown = document.getElementById('projectDropdown');
        
        if (userDropdown.classList.contains('show')) {
          userDropdown.classList.remove('show');
        }
        
        if (projectDropdown.classList.contains('show')) {
          projectDropdown.classList.remove('show');
        }
      });
      
      // 从sessionStorage加载保存的电路数据（如果有）
      loadSavedCircuitIfExists();
    });
    
    // 获取电路数据的几种方式
    function getCircuitData(callback) {
      console.log("开始获取电路数据...");
      
      // 方式0: 检查是否已经从sessionStorage加载了电路
      const loadedCircuit = sessionStorage.getItem('circuit_text_data');
      if (loadedCircuit) {
        console.log("从sessionStorage获取到之前保存的电路数据");
        sessionStorage.removeItem('circuit_text_data');
        callback(loadedCircuit);
        return;
      }
      
      // 方式1: 直接通过导出接口获取
      try {
        console.log("尝试直接通过CircuitJS1.exportCircuit()获取电路数据");
        if (window.CircuitJS1 && typeof window.CircuitJS1.exportCircuit === 'function') {
          const circuitData = window.CircuitJS1.exportCircuit();
          console.log("成功获取电路数据，长度:", circuitData.length);
          callback(circuitData);
          return;
        }
      } catch (e) {
        console.error("通过CircuitJS1.exportCircuit获取失败:", e);
      }
      
      // 方式2: 通过模拟菜单项点击获取
      try {
        console.log("尝试模拟菜单项点击获取电路数据");
        let menuItemFound = false;
        
        // 查找所有菜单项
        const menuItems = document.querySelectorAll('.gwt-MenuItem');
        console.log("发现", menuItems.length, "个菜单项");
        
        // 查找并点击导出为文本菜单项
        menuItems.forEach(item => {
          if (!menuItemFound && item.textContent && 
              (item.textContent.includes('导出为文本') || item.textContent.includes('Export as Text'))) {
            console.log("找到导出为文本菜单项:", item.textContent);
            menuItemFound = true;
            
            // 设置一个事件处理函数来捕获复制事件
            const copyListener = function(e) {
              console.log("捕获到复制事件");
              setTimeout(() => {
                document.removeEventListener('copy', copyListener);
                
                // 从剪贴板获取数据
                const textarea = document.getElementById("circuit-data-textarea");
                if (textarea && textarea.value) {
                  console.log("从文本区域获取到数据，长度:", textarea.value.length);
                  callback(textarea.value);
                }
              }, 200);
            };
            
            document.addEventListener('copy', copyListener);
            
            // 点击菜单项
            setTimeout(() => {
              item.click();
              
              // 如果5秒内没有获取到数据，移除事件监听器
              setTimeout(() => {
                document.removeEventListener('copy', copyListener);
              }, 5000);
            }, 0);
          }
        });
        
        if (!menuItemFound) {
          console.log("未找到导出为文本菜单项");
        }
      } catch (e) {
        console.error("模拟菜单点击获取电路数据失败:", e);
      }
      
      // 方式3: 尝试通过GWT内部对象直接获取
      try {
        console.log("尝试通过GWT内部对象获取电路数据");
        
        // 创建一个全局回调函数
        window.receiveCircuitTextCallback = function(text) {
          if (text) {
            console.log("通过回调获取到电路数据，长度:", text.length);
            circuitTextData = text;
          }
        };
        
        // 通过注入脚本访问GWT对象
        const script = document.createElement('script');
        script.textContent = `
          try {
            if (window.circuitjs1 && window.circuitjs1.theSim) {
              var data = window.circuitjs1.theSim.dumpCircuit();
              if (window.receiveCircuitTextCallback) {
                window.receiveCircuitTextCallback(data);
              }
            } else if (window.CircuitJS1) {
              var data = window.CircuitJS1.exportCircuit();
              if (window.receiveCircuitTextCallback) {
                window.receiveCircuitTextCallback(data);
              }
            } else {
              // 尝试查找其他可能的导出方法
              for (var key in window) {
                if (key.startsWith('__gwt_')) {
                  console.log('检查GWT对象:', key);
                }
              }
            }
          } catch (e) {
            console.error('尝试访问GWT对象失败:', e);
          }
        `;
        document.head.appendChild(script);
        document.head.removeChild(script);
      } catch (e) {
        console.error("通过GWT内部对象获取电路数据失败:", e);
      }
      
      // 设置最大等待时间并开始检查是否有数据
      const maxWaitTime = 3000;
      let startTime = Date.now();
      
      const checkInterval = setInterval(function() {
        if (circuitTextData) {
          clearInterval(checkInterval);
          console.log("获取到电路数据，长度:", circuitTextData.length);
          callback(circuitTextData);
          return;
        }
        
        // 从文本区域检查
        const textArea = document.getElementById("circuit-data-textarea");
        if (textArea && textArea.value && textArea.value.length > 0) {
          clearInterval(checkInterval);
          console.log("从文本区域获取到数据，长度:", textArea.value.length);
          callback(textArea.value);
          return;
        }
        
        // 超时处理
        if (Date.now() - startTime > maxWaitTime) {
          clearInterval(checkInterval);
          console.error("获取电路数据超时");
          
          // 最后尝试通过全局函数
          if (window.getCircuitData && typeof window.getCircuitData === 'function') {
            try {
              const data = window.getCircuitData();
              if (data) {
                console.log("通过全局getCircuitData函数获取到数据，长度:", data.length);
                callback(data);
                return;
              }
            } catch (e) {
              console.error("通过getCircuitData获取失败:", e);
            }
          }
          
          callback(null);
        }
      }, 200);
    }
    
    // 注入脚本到GWT应用
    function injectExportScript() {
      try {
        // 创建一个脚本标签，尝试访问GWT内部对象
        const script = document.createElement('script');
        script.textContent = `
          try {
            console.log("执行注入脚本，尝试访问GWT应用...");
            
            // 尝试访问不同的可能路径
            if (window.circuitjs1 && window.circuitjs1.theSim) {
              console.log("找到theSim对象，尝试调用dumpCircuit()");
              // 直接方式
              var data = window.circuitjs1.theSim.dumpCircuit();
              window.receiveCircuitText(data);
            } else {
              console.log("未找到theSim对象，尝试查找替代方法");
              
              // 寻找所有可能的GWT对象
              var gwt = document.querySelector('[__gwt_ObjectId]');
              if (gwt && gwt.$doExportAsText && typeof gwt.$doExportAsText === 'function') {
                console.log("找到带有$doExportAsText方法的GWT对象");
                gwt.$doExportAsText();
              }
              
              // 尝试模拟菜单点击 - 使用标准DOM API查找菜单项
              console.log("尝试查找菜单项...");
              var menuItems = document.querySelectorAll('.gwt-MenuItem');
              console.log("找到", menuItems.length, "个菜单项");
              
              var fileMenu = null;
              // 遍历所有菜单项，查找"文件"或"File"
              for (var i = 0; i < menuItems.length; i++) {
                var item = menuItems[i];
                console.log("菜单项", i, "内容:", item.textContent);
                if (item.textContent.includes("文件") || 
                    item.textContent.includes("File")) {
                  fileMenu = item;
                  console.log("找到文件菜单项:", item.textContent);
                  break;
                }
              }
              
              if (fileMenu) {
                console.log("点击文件菜单");
                fileMenu.click();
                
                // 等待子菜单出现
                setTimeout(function() {
                  console.log("查找导出菜单项...");
                  var exportMenu = null;
                  var menuItems = document.querySelectorAll('.gwt-MenuItem');
                  
                  for (var i = 0; i < menuItems.length; i++) {
                    var item = menuItems[i];
                    console.log("子菜单项", i, "内容:", item.textContent);
                    if (item.textContent.includes("导出为文本") || 
                        item.textContent.includes("Export as Text") ||
                        item.textContent.includes("导出") ||
                        item.textContent.includes("Export")) {
                      exportMenu = item;
                      console.log("找到导出菜单项:", item.textContent);
                      break;
                    }
                  }
                  
                  if (exportMenu) {
                    console.log("点击导出菜单");
                    exportMenu.click();
                    
                    // 等待复制到剪贴板
                    setTimeout(function() {
                      var textarea = document.getElementById('circuit-data-textarea');
                      if (textarea && textarea.value) {
                        console.log("从文本区域获取数据，长度:", textarea.value.length);
                        window.receiveCircuitText(textarea.value);
                      } else {
                        console.log("文本区域为空或不存在");
                      }
                    }, 300);
                  } else {
                    console.log("未找到导出菜单项");
                  }
                }, 200);
              } else {
                console.log("未找到文件菜单项");
              }
            }
          } catch (e) {
            console.error("注入脚本执行失败:", e);
          }
        `;
        document.head.appendChild(script);
        document.head.removeChild(script);
      } catch (e) {
        console.error("注入脚本失败:", e);
      }
    }
    
    // 从sessionStorage加载保存的电路
    function loadSavedCircuitIfExists() {
      const circuitData = sessionStorage.getItem('openCircuitData');
      const circuitName = sessionStorage.getItem('openCircuitName');
      
      if (circuitData) {
        // 删除保存的数据，防止页面刷新后重复加载
        sessionStorage.removeItem('openCircuitData');
        sessionStorage.removeItem('openCircuitName');
        
        // 由于GWT应用可能还没有完全加载，所以我们需要等待一下
        setTimeout(function() {
          loadCircuitData(circuitData, circuitName);
        }, 1000);
      }
    }
    
    // 加载电路数据
    function loadCircuitData(data, name) {
      try {
        // 创建脚本注入LoadCircuit功能
        const script = document.createElement('script');
        script.textContent = `
          try {
            if (window.circuitjs1 && window.circuitjs1.theSim) {
              // 创建一个Blob对象并使用URL.createObjectURL创建一个URL
              var blob = new Blob([${JSON.stringify(data)}], {type: 'text/plain'});
              var url = URL.createObjectURL(blob);
              
              // 尝试加载电路
              window.circuitjs1.theSim.readCircuit(${JSON.stringify(data)});
              
              // 设置电路标题
              if (${JSON.stringify(name)}) {
                window.circuitjs1.theSim.setCircuitTitle(${JSON.stringify(name)});
              }
              
              console.log("电路加载成功");
              
              // 显示提示
              if (window.showPromptDialog) {
                window.showPromptDialog("电路加载成功: " + ${JSON.stringify(name || "")});
              }
            }
          } catch (e) {
            console.error("加载电路失败:", e);
            if (window.showPromptDialog) {
              window.showPromptDialog("加载电路失败: " + e.message);
            }
          }
        `;
        document.head.appendChild(script);
        document.head.removeChild(script);
      } catch (e) {
        console.error("注入加载电路脚本失败:", e);
        showPromptDialog("加载电路失败: " + e.message);
      }
    }
    
    // 保存电路到云端
    function saveCircuitToCloud(circuitData) {
      // 此函数不再使用，改为调用showProjectSaveDialog
      console.log("已弃用的函数saveCircuitToCloud被调用");
      
      // 检查是否已登录
      const userId = localStorage.getItem('userId');
      if (userId) {
        window.currentCircuitData = circuitData;
        showProjectSaveDialog(userId);
      } else {
        showPromptDialog('未找到用户信息，请重新登录');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
      }
    }

    // 保存电路数据到服务器
    function saveCircuit(circuitSaveData) {
      try {
        console.log("准备保存电路数据:", circuitSaveData.circuitName);
        
        if (!window.API) {
          console.error('API 对象未找到');
          showPromptDialog('保存失败: API 未加载');
          return;
        }
        
        // 显示加载中提示
        showPromptDialog('正在保存项目...');
        
        // 检查认证令牌
        const token = localStorage.getItem('eda_token');
        if (!token) {
          console.error('未找到认证令牌');
          showPromptDialog('认证已过期，请重新登录');
          setTimeout(() => {
            showLoginRequiredDialog();
          }, 1500);
          return;
        }
        
        // 检查数据有效性
        if (!circuitSaveData.userId || !circuitSaveData.circuitName || !circuitSaveData.circuitData) {
          console.error('保存数据不完整:', circuitSaveData);
          showPromptDialog('保存数据不完整，请重试');
          return;
        }
        
        // 添加保存超时保护
        let saveTimeout = setTimeout(() => {
          console.error("保存电路超时");
          showPromptDialog('保存操作超时，请重试');
        }, 30000);
        
        console.log("调用API.saveCircuit");
        window.API.saveCircuit(circuitSaveData)
          .then(response => {
            // 清除超时
            clearTimeout(saveTimeout);
            
            console.log("保存电路响应:", response);
            if (response.code === 200) {
              showPromptDialog('项目保存成功！');
            } else {
              console.error("保存失败:", response);
              showPromptDialog('保存失败: ' + (response.msg || '服务器错误'));
            }
          })
          .catch(error => {
            // 清除超时
            clearTimeout(saveTimeout);
            
            console.error('保存电路出错:', error);
            
            // 检查是否为JWT认证错误
            if (error.message && (error.message.includes('JWT') || error.message.includes('认证失败'))) {
              showPromptDialog('令牌已过期，正在尝试自动重新登录...');
              
              // 尝试自动刷新令牌
              API.refreshToken()
                .then(refreshResponse => {
                  if (refreshResponse.code === 200) {
                    // 令牌已刷新，重新尝试保存
                    showPromptDialog('认证已刷新，重新尝试保存');
                    setTimeout(() => {
                      saveCircuit(circuitSaveData);
                    }, 1000);
                  } else {
                    // 刷新失败，需要手动登录
                    showPromptDialog('自动登录失败，请重新登录');
                    setTimeout(() => {
                      showLoginRequiredDialog();
                    }, 1500);
                  }
                })
                .catch(refreshError => {
                  console.error('刷新令牌失败:', refreshError);
                  showPromptDialog('需要重新登录');
                  setTimeout(() => {
                    showLoginRequiredDialog();
                  }, 1500);
                });
            } else {
              const errorMsg = error.message || '未知错误';
              showPromptDialog('保存失败: ' + errorMsg);
            }
          });
      } catch (error) {
        console.error("saveCircuit函数执行出错:", error);
        showPromptDialog('保存过程中出错: ' + error.message);
      }
    }

    // 显示提示对话框
    function showPromptDialog(message) {
      // 检查是否已有提示框
      const existingPrompt = document.querySelector('.prompt-dialog');
      if (existingPrompt) {
        document.body.removeChild(existingPrompt);
      }
      
      // 创建提示框
      const prompt = document.createElement('div');
      prompt.className = 'prompt-dialog';
      prompt.style.position = 'fixed';
      prompt.style.top = '50%';
      prompt.style.left = '50%';
      prompt.style.transform = 'translate(-50%, -50%)';
      prompt.style.backgroundColor = 'white';
      prompt.style.padding = '20px';
      prompt.style.borderRadius = '8px';
      prompt.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
      prompt.style.zIndex = '3000';
      prompt.style.minWidth = '300px';
      prompt.style.textAlign = 'center';
      
      const messageElem = document.createElement('p');
      messageElem.textContent = message;
      messageElem.style.margin = '0 0 15px 0';
      prompt.appendChild(messageElem);
      
      const okButton = document.createElement('button');
      okButton.textContent = '确定';
      okButton.style.padding = '8px 16px';
      okButton.style.borderRadius = '4px';
      okButton.style.border = 'none';
      okButton.style.backgroundColor = '#5e35b1';
      okButton.style.color = 'white';
      okButton.style.cursor = 'pointer';
      okButton.onclick = function() {
        document.body.removeChild(prompt);
      };
      prompt.appendChild(okButton);
      
      document.body.appendChild(prompt);
      
      // 3秒后自动关闭
      setTimeout(function() {
        if (document.body.contains(prompt)) {
          document.body.removeChild(prompt);
        }
      }, 3000);
    }

    // 显示项目保存对话框
    function showProjectSaveDialog(userId) {
      console.log("显示项目保存对话框");
      
      try {
        // 获取对话框元素
        const overlay = document.getElementById('project-save-overlay');
        const container = document.getElementById('project-list-container');
        
        if (!overlay || !container) {
          console.error("找不到对话框元素", !!overlay, !!container);
          showPromptDialog("页面元素丢失，无法显示保存对话框");
          return;
        }
        
        // 显示加载中状态
        container.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #5e35b1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
            <p>正在加载您的项目...</p>
          </div>
        `;
        
        // 显示对话框
        overlay.style.display = 'block';
        
        // 绑定取消按钮事件
        document.getElementById('cancel-save-btn').onclick = function() {
          overlay.style.display = 'none';
        };
        
        // 加载项目列表
        console.log("请求用户项目列表...");
        loadProjectList(userId);
        
      } catch (error) {
        console.error("显示保存对话框出错:", error);
        showPromptDialog("显示保存对话框出错: " + error.message);
      }
    }

    // 加载项目列表
    function loadProjectList(userId) {
      const container = document.getElementById('project-list-container');
      const overlay = document.getElementById('project-save-overlay');
      const defaultName = "我的电路 " + new Date().toLocaleString();
      
      API.getUserCircuits(userId)
        .then(response => {
          console.log("获取到项目列表:", response);
          
          if (response.code === 200 && response.data && response.data.length > 0) {
            // 有项目，显示列表
            let html = `
              <h3 style="margin:10px 0;font-size:16px;color:#666;font-weight:normal;">选择要覆盖的项目</h3>
              <div style="max-height:200px;overflow-y:auto;border:1px solid #eee;border-radius:8px;margin-bottom:15px;">
            `;
            
            response.data.forEach((circuit, index) => {
              html += `
                <div class="project-item" style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;" onclick="selectProject(${index})">
                  <input type="radio" name="project" value="${circuit.circuitId}" id="project-${index}" style="margin-right:10px;">
                  <label for="project-${index}" style="cursor:pointer;">
                    <div style="font-weight:500;">${circuit.circuitName}</div>
                    <div style="font-size:12px;color:#888;">${new Date(circuit.updateTime || circuit.createTime).toLocaleString()}</div>
                  </label>
                </div>
              `;
            });
            
            html += `</div>`;
            
            // 新建项目表单
            html += `
              <h3 style="margin:15px 0 10px;font-size:16px;color:#666;font-weight:normal;">或创建新项目</h3>
              <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;">项目名称:</label>
                <input type="text" id="new-project-name" style="width:100%;padding:8px;box-sizing:border-box;border-radius:4px;border:1px solid #ccc;" value="${defaultName}">
              </div>
              <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;">描述 (可选):</label>
                <textarea id="new-project-desc" style="width:100%;padding:8px;box-sizing:border-box;border-radius:4px;border:1px solid #ccc;min-height:60px;resize:vertical;"></textarea>
              </div>
              <div>
                <label style="display:flex;align-items:center;">
                  <input type="checkbox" id="new-project-public"> 
                  <span style="margin-left:5px;">公开此项目（允许其他用户查看）</span>
                </label>
              </div>
            `;
            
            container.innerHTML = html;
            
            // 存储项目数据到全局变量
            window.projectsList = response.data;
            
          } else {
            // 没有项目，只显示新建项目表单
            container.innerHTML = `
              <p style="text-align:center;color:#666;margin-bottom:15px;">您还没有保存过项目</p>
              <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;">项目名称:</label>
                <input type="text" id="new-project-name" style="width:100%;padding:8px;box-sizing:border-box;border-radius:4px;border:1px solid #ccc;" value="${defaultName}">
              </div>
              <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;">描述 (可选):</label>
                <textarea id="new-project-desc" style="width:100%;padding:8px;box-sizing:border-box;border-radius:4px;border:1px solid #ccc;min-height:60px;resize:vertical;"></textarea>
              </div>
              <div>
                <label style="display:flex;align-items:center;">
                  <input type="checkbox" id="new-project-public"> 
                  <span style="margin-left:5px;">公开此项目（允许其他用户查看）</span>
                </label>
              </div>
            `;
          }
          
          // 绑定保存按钮事件
          document.getElementById('confirm-save-btn').onclick = function() {
            const selectedRadio = document.querySelector('input[name="project"]:checked');
            const circuitData = window.currentCircuitData;
            
            if (!circuitData) {
              showPromptDialog('电路数据丢失，请重试');
              overlay.style.display = 'none';
              return;
            }
            
            if (selectedRadio) {
              // 覆盖现有项目
              const circuitId = parseInt(selectedRadio.value);
              const selectedCircuit = window.projectsList.find(c => c.circuitId === circuitId);
              
              if (selectedCircuit) {
                saveCircuit({
                  circuitId: selectedCircuit.circuitId,
                  userId: parseInt(userId),
                  circuitName: selectedCircuit.circuitName,
                  circuitData: circuitData,
                  description: selectedCircuit.description,
                  isPublic: selectedCircuit.isPublic
                });
              }
            } else {
              // 新建项目
              const nameInput = document.getElementById('new-project-name');
              const descInput = document.getElementById('new-project-desc');
              const publicCheckbox = document.getElementById('new-project-public');
              
              if (!nameInput || !nameInput.value.trim()) {
                showPromptDialog('请输入项目名称');
                return;
              }
              
              saveCircuit({
                userId: parseInt(userId),
                circuitName: nameInput.value.trim(),
                circuitData: circuitData,
                description: descInput ? descInput.value.trim() : '',
                isPublic: publicCheckbox && publicCheckbox.checked ? '1' : '0'
              });
            }
            
            // 隐藏对话框
            overlay.style.display = 'none';
          };
          
        })
        .catch(error => {
          console.error("加载项目列表失败:", error);
          
          // 检查是否是认证错误
          if (error.message && (error.message.includes('401') || error.message.includes('JWT'))) {
            console.log("认证错误，尝试重新登录");
            overlay.style.display = 'none';
            showAutoLoginDialog();
            return;
          }
          
          container.innerHTML = `
            <p style="color:#f44336;text-align:center;">加载项目列表失败: ${error.message}</p>
            <div style="margin-bottom:10px;">
              <label style="display:block;margin-bottom:5px;">项目名称:</label>
              <input type="text" id="new-project-name" style="width:100%;padding:8px;box-sizing:border-box;border-radius:4px;border:1px solid #ccc;" value="${defaultName}">
            </div>
            <div style="margin-bottom:10px;">
              <label style="display:block;margin-bottom:5px;">描述 (可选):</label>
              <textarea id="new-project-desc" style="width:100%;padding:8px;box-sizing:border-box;border-radius:4px;border:1px solid #ccc;min-height:60px;resize:vertical;"></textarea>
            </div>
            <div>
              <label style="display:flex;align-items:center;">
                <input type="checkbox" id="new-project-public"> 
                <span style="margin-left:5px;">公开此项目（允许其他用户查看）</span>
              </label>
            </div>
          `;
          
          // 绑定保存按钮事件 - 仅新建项目
          document.getElementById('confirm-save-btn').onclick = function() {
            const nameInput = document.getElementById('new-project-name');
            const descInput = document.getElementById('new-project-desc');
            const publicCheckbox = document.getElementById('new-project-public');
            const circuitData = window.currentCircuitData;
            
            if (!circuitData) {
              showPromptDialog('电路数据丢失，请重试');
              overlay.style.display = 'none';
              return;
            }
            
            if (!nameInput || !nameInput.value.trim()) {
              showPromptDialog('请输入项目名称');
              return;
            }
            
            saveCircuit({
              userId: parseInt(userId),
              circuitName: nameInput.value.trim(),
              circuitData: circuitData,
              description: descInput ? descInput.value.trim() : '',
              isPublic: publicCheckbox && publicCheckbox.checked ? '1' : '0'
            });
            
            // 隐藏对话框
            overlay.style.display = 'none';
          };
        });
    }

    // 项目选择函数
    window.selectProject = function(index) {
      const radio = document.getElementById(`project-${index}`);
      if (radio) {
        radio.checked = true;
        
        // 高亮选中项
        document.querySelectorAll('.project-item').forEach(item => {
          item.style.backgroundColor = 'transparent';
        });
        radio.closest('.project-item').style.backgroundColor = '#f0e6ff';
      }
    };
  </script>
  
  <!-- Include the next line to allow support for dropbox import/export. You will need your own app key. -->
  <!--<script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="YOUR_KEY"></script>-->

  <script language="javascript" src="lz-string.min.js"></script>
   
    <!-- This script tag is what actually loads the GWT module.  The -->
    <!-- 'nocache.js' file (also called a "selection script") is     -->
    <!-- produced by the GWT compiler in the module output directory -->
    <!-- or generated automatically in development mode.             -->
    <script language="javascript" src="circuitjs1/circuitjs1.nocache.js"></script>
    
    <!-- Include a history iframe to enable full GWT history support -->
    <!-- (the id must be exactly as shown)                           -->
    <iframe src="javascript:''" id="__gwt_historyFrame" style="width:0;height:0;border:0"></iframe>
    
    <script>
    // 等待GWT应用初始化并注册导出函数
    function waitForCircuitJS1() {
      let attempts = 0;
      const maxAttempts = 50; // 最多尝试50次，约10秒
      
      const checkInterval = setInterval(() => {
        attempts++;
        console.log(`等待CircuitJS1初始化，第${attempts}次尝试`);
        
        if (window.CircuitJS1 && typeof window.CircuitJS1.exportCircuit === 'function') {
          clearInterval(checkInterval);
          console.log('CircuitJS1.exportCircuit已可用，注册全局函数');
          
          // 注册全局获取电路数据函数
          window.getCircuitData = function() {
            try {
              const data = window.CircuitJS1.exportCircuit();
              console.log('通过CircuitJS1.exportCircuit获取到电路数据，长度:', data.length);
              // console.log('电路数据:', data);
              return data;
            } catch (e) {
              console.error('通过CircuitJS1.exportCircuit获取电路数据失败:', e);
              return null;
            }
          };
        } else if (attempts >= maxAttempts) {
          clearInterval(checkInterval);
          console.warn('等待CircuitJS1初始化超时');
        }
      }, 200);
    }
    
    // 在页面加载完成后开始等待
    window.addEventListener('load', waitForCircuitJS1);
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
	navigator.serviceWorker.register('service-worker.js').then(registration => {
	  console.log('Service Worker registered with scope:', registration.scope);
	}).catch(error => {
	  console.error('Service Worker registration failed:', error);
	});
      });
    }
    </script>
    
    <!-- 添加预定义的项目保存对话框 -->
<div id="project-save-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999;">
  <div id="project-save-dialog" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
    <h2 style="margin-top: 0; color: #5e35b1; text-align: center;">保存项目</h2>
    <div id="project-list-container" style="margin-bottom: 20px;">
      <!-- 这里将由JavaScript填充内容 -->
      <div style="text-align: center; padding: 20px;">
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #5e35b1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
        <p>正在加载...</p>
      </div>
    </div>
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button id="cancel-save-btn" style="padding: 8px 16px; background-color: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">取消</button>
      <button id="confirm-save-btn" style="padding: 8px 16px; background-color: #5e35b1; color: white; border: none; border-radius: 4px; cursor: pointer;">保存</button>
    </div>
  </div>
</div>

<!-- 添加右上角弹出菜单样式的项目保存组件 -->
<div id="project-save-popup" style="display: none; position: fixed; top: 80px; right: 20px; width: 350px; max-width: 90vw; background-color: white; border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.18); z-index: 10000; overflow: hidden;">
  <div style="background-color: #5e35b1; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
    <h3 style="margin: 0; font-size: 18px;">保存项目</h3>
    <div id="close-project-popup" style="cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </div>
  </div>
  <div id="project-menu-container" style="padding: 15px; max-height: 70vh; overflow-y: auto;">
    <!-- 内容将由JavaScript动态填充 -->
    <div style="text-align: center; padding: 20px;">
      <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #5e35b1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
      <p>正在加载您的项目...</p>
    </div>
  </div>
</div>

<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  #project-save-popup {
    animation: slideInRight 0.3s ease-out;
    border: 1px solid #eaeaea;
  }
  .project-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .project-item:hover {
    background-color: #f9f4ff;
  }
  .project-item.selected {
    background-color: #f0e6ff;
  }
  .popup-btn {
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    border: none;
    transition: background-color 0.2s;
  }
  .popup-btn-primary {
    background-color: #5e35b1;
    color: white;
  }
  .popup-btn-secondary {
    background-color: #f5f5f5;
    border: 1px solid #ddd;
    color: #333;
  }
  .popup-btn:hover {
    opacity: 0.9;
  }
  .popup-btn:active {
    transform: translateY(1px);
  }
</style>

<script>
// 保存到云端功能
document.getElementById('saveToCloudBtn').addEventListener('click', function(e) {
  e.preventDefault();
  
  console.log("保存到云端按钮被点击");
  
  // 隐藏下拉菜单
  document.getElementById('projectDropdown').classList.remove('show');
  
  // 检查是否已登录
  const userId = localStorage.getItem('userId');
  const token = localStorage.getItem('eda_token');
  
  // 验证用户登录状态
  if (!userId || !token) {
    console.log("未找到用户信息或令牌，需要登录");
    showLoginRequiredDialog();
    return;
  }
  
  // 主动尝试刷新令牌，然后再进行保存操作
  console.log("主动尝试刷新令牌");
  
  // 检查是否有保存的登录信息
  const savedUsername = localStorage.getItem('saved_username');
  const savedPassword = localStorage.getItem('saved_password');
  
  if (savedUsername && savedPassword) {
    try {
      // 解码密码
      const decodedPassword = atob(savedPassword);
      
      // 尝试自动重新登录以刷新令牌
      API.login({
        username: savedUsername,
        password: decodedPassword,
        rememberMe: true
      })
      .then(loginResponse => {
        console.log("自动刷新令牌结果:", loginResponse);
        if (loginResponse.code === 200) {
          // 刷新令牌成功，继续保存操作
          console.log("令牌刷新成功，继续保存操作");
          getAndSaveCircuitDataGWT();
        } else {
          console.log("自动登录失败，尝试使用当前令牌");
          // 尝试使用当前令牌验证
          validateTokenAndSave();
        }
      })
      .catch(loginError => {
        console.error("自动登录失败:", loginError);
        // 尝试使用当前令牌验证
        validateTokenAndSave();
      });
    } catch (decodeError) {
      console.error("解码密码失败:", decodeError);
      // 尝试使用当前令牌验证
      validateTokenAndSave();
    }
  } else {
    // 无法自动登录，尝试使用当前令牌验证
    console.log("没有保存的登录信息，尝试使用当前令牌");
    validateTokenAndSave();
  }
  
  // 使用当前令牌进行验证
  function validateTokenAndSave() {
    API.validateToken()
      .then(response => {
        console.log("验证令牌结果:", response);
        if (response.code === 200) {
          // 令牌有效，继续保存操作
          getAndSaveCircuitDataGWT();
        } else {
          console.log("令牌无效，提示用户重新登录");
          showLoginRequiredDialog();
        }
      })
      .catch(error => {
        console.error("验证令牌失败:", error);
        showLoginRequiredDialog();
      });
  }
});

// 获取电路数据并保存
function getAndSaveCircuitData() {
  try {
    console.log("开始获取电路数据并准备保存...");
    
    // 先清理可能已经存在的文本区域
    const existingTextArea = document.getElementById("circuit-data-textarea");
    if (existingTextArea) {
      console.log("发现已存在的文本区域，先移除");
      document.body.removeChild(existingTextArea);
    }
    
    // 清理可能存在的多余文本区域（具有相同类名但ID可能不同）
    document.querySelectorAll('textarea[style*="opacity: 0"]').forEach(elem => {
      if (elem !== existingTextArea) {
        console.log("发现多余的隐藏文本区域，移除");
        elem.parentNode.removeChild(elem);
      }
    });
    
    // 创建一个隐藏的文本区域，用于复制电路数据
    let textArea = document.createElement("textarea");
    textArea.id = "circuit-data-textarea";
    textArea.style.position = "fixed";
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.width = "2em";
    textArea.style.height = "2em";
    textArea.style.opacity = 0;
    document.body.appendChild(textArea);
    
    // 重置全局变量
    circuitTextData = null;
    
    // 尝试获取电路数据
    getCircuitData(function(data) {
      try {
        console.log("获取电路数据结果:", data ? "成功，数据长度=" + data.length : "失败");
        
        // 无论成功与否，都清理临时DOM元素
        const tempTextArea = document.getElementById("circuit-data-textarea");
        if (tempTextArea) {
          document.body.removeChild(tempTextArea);
        }
        
        if (data) {
          // 存储电路数据到全局变量
          window.currentCircuitData = data;
          
          // 显示右上角弹出菜单
          showProjectMenu();
        } else {
          showPromptDialog("无法获取电路数据。请尝试使用'文件->导出为文本'手动保存。");
        }
      } catch (innerError) {
        console.error("处理电路数据时出错:", innerError);
        showPromptDialog("处理电路数据时出错: " + innerError.message);
        
        // 确保清理临时DOM元素
        const tempTextArea = document.getElementById("circuit-data-textarea");
        if (tempTextArea) {
          document.body.removeChild(tempTextArea);
        }
      }
    });
  } catch (outerError) {
    console.error("准备获取电路数据时出错:", outerError);
    showPromptDialog("准备获取电路数据时出错: " + outerError.message);
    
    // 确保清理临时DOM元素
    const tempTextArea = document.getElementById("circuit-data-textarea");
    if (tempTextArea) {
      document.body.removeChild(tempTextArea);
    }
  }
}

// 显示项目保存菜单
function showProjectMenu() {
  console.log("显示项目保存菜单");
  
  try {
    // 获取菜单元素
    const popup = document.getElementById('project-save-popup');
    const container = document.getElementById('project-menu-container');
    
    if (!popup || !container) {
      console.error("找不到菜单元素", !!popup, !!container);
      showPromptDialog("页面元素丢失，无法显示保存菜单");
      return;
    }
    
    // 确保菜单可见
    popup.style.display = 'block';
    
    // 绑定关闭按钮事件
    document.getElementById('close-project-popup').onclick = function() {
      console.log("点击了关闭按钮");
      popup.style.display = 'none';
    };
    
    // 显示加载中状态
    container.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #5e35b1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
        <p>正在加载您的项目...</p>
      </div>
    `;
    
    // 加载项目列表
    console.log("请求用户项目列表...");
    loadProjectMenuItems();
    
  } catch (error) {
    console.error("显示保存菜单出错:", error);
    showPromptDialog("显示保存菜单出错: " + error.message);
  }
}

// 加载项目菜单项
function loadProjectMenuItems() {
  console.log("加载项目菜单项");
  
  const userId = localStorage.getItem('userId');
  const container = document.getElementById('project-menu-container');
  const popup = document.getElementById('project-save-popup');
  const defaultName = "我的电路 " + new Date().toLocaleString();
  
  // 确保元素存在
  if (!container || !popup || !userId) {
    console.error("缺少必要的元素或用户ID");
    return;
  }
  
  API.getUserCircuits(userId)
    .then(response => {
      console.log("获取到项目列表响应:", response);
      
      // 准备菜单内容HTML
      let html = '';
      let hasProjects = response.code === 200 && response.data && response.data.length > 0;
      
      // 顶部控制按钮
      html += `
        <div style="display: flex; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
          <button id="menu-show-projects" class="popup-btn popup-btn-secondary" style="flex: 1; margin-right: 5px;">我的项目</button>
          <button id="menu-create-new" class="popup-btn popup-btn-secondary" style="flex: 1; margin-left: 5px;">新建项目</button>
        </div>
      `;
      
      // 项目列表容器
      html += `<div id="project-list-section" style="display: ${hasProjects ? 'block' : 'none'};">`;
      
      if (hasProjects) {
        html += `<h4 style="margin: 0 0 10px; font-size: 16px; color: #444;">选择要覆盖的项目</h4>`;
        html += `<div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">`;
        
        // 添加项目列表
        response.data.forEach((circuit, index) => {
          html += `
            <div class="project-item" data-id="${circuit.circuitId}" data-index="${index}">
              <div style="font-weight: 500; margin-bottom: 3px;">${circuit.circuitName}</div>
              <div style="font-size: 12px; color: #888;">${new Date(circuit.updateTime || circuit.createTime).toLocaleString()}</div>
            </div>
          `;
        });
        
        html += `</div>`;
      } else {
        html += `<p style="color: #666; text-align: center; margin-bottom: 15px;">您还没有保存过项目</p>`;
      }
      html += `</div>`;
      
      // 新建项目表单
      html += `
        <div id="new-project-section" style="display: none;">
          <h4 style="margin: 0 0 10px; font-size: 16px; color: #444;">创建新项目</h4>
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-size: 14px;">项目名称:</label>
            <input type="text" id="new-project-name" style="width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc;" value="${defaultName}">
          </div>
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-size: 14px;">描述 (可选):</label>
            <textarea id="new-project-desc" style="width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; min-height: 60px; resize: vertical;"></textarea>
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; font-size: 14px;">
              <input type="checkbox" id="new-project-public"> 
              <span style="margin-left: 5px;">公开此项目（允许其他用户查看）</span>
            </label>
          </div>
        </div>
      `;
      
      // 底部操作按钮
      html += `
        <div style="display: flex; justify-content: flex-end; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
          <button id="menu-cancel-btn" class="popup-btn popup-btn-secondary" style="margin-right: 10px;">取消</button>
          <button id="menu-save-btn" class="popup-btn popup-btn-primary">保存</button>
        </div>
      `;
      
      // 更新容器内容
      container.innerHTML = html;
      
      // 存储项目数据到全局变量
      if (hasProjects) {
        window.projectsList = response.data;
      }
      
      // 绑定按钮事件
      bindMenuEvents(userId);
      
      // 默认显示:
      // - 如果有项目，显示项目列表
      // - 如果没有项目，显示新建项目表单
      if (hasProjects) {
        document.getElementById('project-list-section').style.display = 'block';
        document.getElementById('new-project-section').style.display = 'none';
        document.getElementById('menu-show-projects').classList.add('popup-btn-primary');
        document.getElementById('menu-show-projects').classList.remove('popup-btn-secondary');
      } else {
        document.getElementById('project-list-section').style.display = 'none';
        document.getElementById('new-project-section').style.display = 'block';
        document.getElementById('menu-create-new').classList.add('popup-btn-primary');
        document.getElementById('menu-create-new').classList.remove('popup-btn-secondary');
      }
    })
    .catch(error => {
      console.error("加载项目列表失败:", error);
      
      // 检查是否是认证错误
      if (error.message && (error.message.includes('401') || error.message.includes('JWT'))) {
        console.log("认证错误，尝试重新登录");
        popup.style.display = 'none';
        showAutoLoginDialog();
        return;
      }
      
      // 显示错误信息和新建项目表单
      container.innerHTML = `
        <p style="color: #f44336; text-align: center; margin-bottom: 15px;">加载项目列表失败: ${error.message}</p>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-size: 14px;">项目名称:</label>
          <input type="text" id="new-project-name" style="width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc;" value="${defaultName}">
        </div>
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-size: 14px;">描述 (可选):</label>
          <textarea id="new-project-desc" style="width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; min-height: 60px; resize: vertical;"></textarea>
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: flex; align-items: center; font-size: 14px;">
            <input type="checkbox" id="new-project-public"> 
            <span style="margin-left: 5px;">公开此项目（允许其他用户查看）</span>
          </label>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
          <button id="menu-cancel-btn" class="popup-btn popup-btn-secondary" style="margin-right: 10px;">取消</button>
          <button id="menu-save-btn" class="popup-btn popup-btn-primary">保存</button>
        </div>
      `;
      
      // 绑定简化版的事件处理
      document.getElementById('menu-cancel-btn').onclick = function() {
        popup.style.display = 'none';
      };
      
      document.getElementById('menu-save-btn').onclick = function() {
        const nameInput = document.getElementById('new-project-name');
        const descInput = document.getElementById('new-project-desc');
        const publicCheckbox = document.getElementById('new-project-public');
        const circuitData = window.currentCircuitData;
        
        if (!circuitData) {
          showPromptDialog('电路数据丢失，请重试');
          popup.style.display = 'none';
          return;
        }
        
        if (!nameInput || !nameInput.value.trim()) {
          showPromptDialog('请输入项目名称');
          return;
        }
        
        saveCircuit({
          userId: parseInt(userId),
          circuitName: nameInput.value.trim(),
          circuitData: circuitData,
          description: descInput ? descInput.value.trim() : '',
          isPublic: publicCheckbox && publicCheckbox.checked ? '1' : '0'
        });
        
        // 隐藏菜单
        popup.style.display = 'none';
      };
    });
}

// 绑定菜单交互事件
function bindMenuEvents(userId) {
  const popup = document.getElementById('project-save-popup');
  
  // 切换按钮
  document.getElementById('menu-show-projects').onclick = function() {
    document.getElementById('project-list-section').style.display = 'block';
    document.getElementById('new-project-section').style.display = 'none';
    
    this.classList.add('popup-btn-primary');
    this.classList.remove('popup-btn-secondary');
    document.getElementById('menu-create-new').classList.remove('popup-btn-primary');
    document.getElementById('menu-create-new').classList.add('popup-btn-secondary');
  };
  
  document.getElementById('menu-create-new').onclick = function() {
    document.getElementById('project-list-section').style.display = 'none';
    document.getElementById('new-project-section').style.display = 'block';
    
    this.classList.add('popup-btn-primary');
    this.classList.remove('popup-btn-secondary');
    document.getElementById('menu-show-projects').classList.remove('popup-btn-primary');
    document.getElementById('menu-show-projects').classList.add('popup-btn-secondary');
  };
  
  // 项目项选择
  document.querySelectorAll('.project-item').forEach(item => {
    item.onclick = function() {
      // 移除其他项目的选中状态
      document.querySelectorAll('.project-item').forEach(p => p.classList.remove('selected'));
      // 添加当前项目的选中状态
      this.classList.add('selected');
      // 保存所选项目索引
      window.selectedProjectIndex = parseInt(this.dataset.index);
    };
  });
  
  // 取消按钮
  document.getElementById('menu-cancel-btn').onclick = function() {
    popup.style.display = 'none';
  };
  
  // 保存按钮
  document.getElementById('menu-save-btn').onclick = function() {
    const circuitData = window.currentCircuitData;
    
    if (!circuitData) {
      showPromptDialog('电路数据丢失，请重试');
      popup.style.display = 'none';
      return;
    }
    
    // 检查是新建还是覆盖
    if (document.getElementById('new-project-section').style.display === 'block') {
      // 新建项目
      const nameInput = document.getElementById('new-project-name');
      const descInput = document.getElementById('new-project-desc');
      const publicCheckbox = document.getElementById('new-project-public');
      
      if (!nameInput || !nameInput.value.trim()) {
        showPromptDialog('请输入项目名称');
        return;
      }
      
      console.log("保存新项目:", nameInput.value.trim());
      saveCircuit({
        userId: parseInt(userId),
        circuitName: nameInput.value.trim(),
        circuitData: circuitData,
        description: descInput ? descInput.value.trim() : '',
        isPublic: publicCheckbox && publicCheckbox.checked ? '1' : '0'
      });
    } else {
      // 覆盖项目
      const selectedProjectIndex = window.selectedProjectIndex;
      const selectedItem = document.querySelector('.project-item.selected');
      
      if (selectedItem && typeof selectedProjectIndex !== 'undefined' && window.projectsList) {
        const selectedCircuit = window.projectsList[selectedProjectIndex];
        if (selectedCircuit) {
          console.log("覆盖现有项目:", selectedCircuit.circuitName);
          saveCircuit({
            circuitId: selectedCircuit.circuitId,
            userId: parseInt(userId),
            circuitName: selectedCircuit.circuitName,
            circuitData: circuitData,
            description: selectedCircuit.description,
            isPublic: selectedCircuit.isPublic
          });
        } else {
          showPromptDialog('请选择要覆盖的项目或创建新项目');
          return;
        }
      } else {
        showPromptDialog('请选择要覆盖的项目或创建新项目');
        return;
      }
    }
    
    // 隐藏菜单
    popup.style.display = 'none';
  };
}

// 显示登录提醒对话框
function showLoginRequiredDialog() {
  // 检查是否已有提示框
  const existingDialog = document.querySelector('.login-dialog');
  if (existingDialog) {
    document.body.removeChild(existingDialog);
  }
  
  // 创建对话框
  const dialog = document.createElement('div');
  dialog.className = 'login-dialog';
  dialog.style.position = 'fixed';
  dialog.style.top = '50%';
  dialog.style.left = '50%';
  dialog.style.transform = 'translate(-50%, -50%)';
  dialog.style.backgroundColor = 'white';
  dialog.style.padding = '25px';
  dialog.style.borderRadius = '10px';
  dialog.style.boxShadow = '0 5px 25px rgba(0, 0, 0, 0.25)';
  dialog.style.zIndex = '10001'; // 高于其他对话框
  dialog.style.textAlign = 'center';
  dialog.style.width = '350px';
  dialog.style.maxWidth = '90vw';
  
  const title = document.createElement('h2');
  title.textContent = '需要重新登录';
  title.style.margin = '0 0 15px';
  title.style.color = '#5e35b1';
  dialog.appendChild(title);
  
  const message = document.createElement('p');
  message.textContent = '您的登录状态已过期，需要重新登录才能保存项目。';
  message.style.marginBottom = '20px';
  dialog.appendChild(message);
  
  const btnContainer = document.createElement('div');
  btnContainer.style.display = 'flex';
  btnContainer.style.justifyContent = 'center';
  btnContainer.style.gap = '15px';
  
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = '取消';
  cancelBtn.className = 'popup-btn popup-btn-secondary';
  cancelBtn.style.padding = '8px 20px';
  cancelBtn.onclick = function() {
    document.body.removeChild(dialog);
  };
  btnContainer.appendChild(cancelBtn);
  
  const loginBtn = document.createElement('button');
  loginBtn.textContent = '去登录';
  loginBtn.className = 'popup-btn popup-btn-primary';
  loginBtn.style.padding = '8px 20px';
  loginBtn.onclick = function() {
    // 保存当前电路数据到会话，以便登录后返回
    if (window.currentCircuitData) {
      sessionStorage.setItem('pending_save_circuit', window.currentCircuitData);
      sessionStorage.setItem('return_url', window.location.href);
    }
    window.location.href = 'login.html';
  };
  btnContainer.appendChild(loginBtn);
  
  dialog.appendChild(btnContainer);
  document.body.appendChild(dialog);
}
</script>

<!-- 引入API.js -->
<script src="api.js"></script>

<!-- 添加GWT兼容的弹窗容器 -->
<div id="gwt-save-dialog-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 100000;">
  <!-- 使用iframe作为隔离层，防止GWT干扰弹窗层 -->
  <iframe id="gwt-dialog-barrier" style="position: absolute; border: none; top: 0; left: 0; width: 100%; height: 100%; background: transparent;"></iframe>
  
  <!-- 弹窗遮罩层 -->
  <div id="gwt-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);"></div>
  
  <!-- 弹窗内容 -->
  <div id="gwt-dialog" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 400px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
      <h3 id="gwt-dialog-title" style="margin: 0; font-size: 18px; color: #5e35b1;">保存项目</h3>
      <div id="gwt-dialog-close" style="cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </div>
    </div>
    
    <div id="gwt-dialog-content"></div>
    
    <div id="gwt-dialog-buttons" style="display: flex; justify-content: flex-end; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
      <!-- 按钮将由JavaScript动态添加 -->
    </div>
  </div>
</div>

<style>
/* GWT兼容的对话框样式 */
@keyframes gwtFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes gwtSlideIn {
  from { transform: translate(-50%, -45%); opacity: 0; }
  to { transform: translate(-50%, -50%); opacity: 1; }
}

#gwt-save-dialog-container {
  animation: gwtFadeIn 0.2s ease-out;
}

#gwt-dialog {
  animation: gwtSlideIn 0.3s ease-out;
}

.gwt-btn {
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
  border: none;
  transition: all 0.2s;
  margin-left: 10px;
}

.gwt-btn-primary {
  background-color: #5e35b1;
  color: white;
}

.gwt-btn-secondary {
  background-color: #f5f5f5;
  border: 1px solid #ddd;
  color: #333;
}

.gwt-btn:hover {
  opacity: 0.9;
}

.gwt-btn:active {
  transform: translateY(1px);
}

.gwt-project-item {
  padding: 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background-color 0.2s;
}

.gwt-project-item:hover {
  background-color: #f9f4ff;
}

.gwt-project-item.selected {
  background-color: #f0e6ff;
}

/* 确保弹窗在GWT之上显示 */
#gwt-save-dialog-container * {
  font-family: Arial, sans-serif;
  box-sizing: border-box;
}
</style>

<script>
// GWT兼容的对话框工具
const GWTDialog = {
  container: null,
  overlay: null,
  dialog: null,
  barrier: null,
  content: null,
  titleElem: null,
  buttonsContainer: null,
  closeBtn: null,
  
  // 初始化对话框元素
  init: function() {
    this.container = document.getElementById('gwt-save-dialog-container');
    this.barrier = document.getElementById('gwt-dialog-barrier');
    this.overlay = document.getElementById('gwt-overlay');
    this.dialog = document.getElementById('gwt-dialog');
    this.content = document.getElementById('gwt-dialog-content');
    this.titleElem = document.getElementById('gwt-dialog-title');
    this.buttonsContainer = document.getElementById('gwt-dialog-buttons');
    this.closeBtn = document.getElementById('gwt-dialog-close');
    
    // 绑定关闭按钮事件
    this.closeBtn.onclick = () => this.close();
    
    // 绑定点击遮罩层关闭对话框
    this.overlay.onclick = (e) => {
      if (e.target === this.overlay) {
        this.close();
      }
    };
    
    console.log("GWT对话框工具已初始化");
  },
  
  // 显示对话框
  open: function({ title, content, buttons }) {
    if (!this.container) this.init();
    
    // 设置标题
    if (title) this.titleElem.textContent = title;
    
    // 清空内容和按钮
    this.content.innerHTML = '';
    this.buttonsContainer.innerHTML = '';
    
    // 添加内容
    if (typeof content === 'string') {
      this.content.innerHTML = content;
    } else if (content instanceof HTMLElement) {
      this.content.appendChild(content);
    }
    
    // 添加按钮
    if (buttons && buttons.length) {
      buttons.forEach(btn => {
        const button = document.createElement('button');
        button.textContent = btn.text;
        button.className = `gwt-btn ${btn.primary ? 'gwt-btn-primary' : 'gwt-btn-secondary'}`;
        button.onclick = btn.onClick;
        this.buttonsContainer.appendChild(button);
      });
    }
    
    // 显示对话框
    this.container.style.display = 'block';
    
    // 确保对话框在最上层
    setTimeout(() => {
      this.dialog.style.zIndex = '100002';
      this.overlay.style.zIndex = '100001';
      this.barrier.style.zIndex = '100000';
    }, 0);
    
    console.log("GWT对话框已打开");
  },
  
  // 关闭对话框
  close: function() {
    if (this.container) {
      this.container.style.display = 'none';
      console.log("GWT对话框已关闭");
    }
  },
  
  // 显示加载中
  showLoading: function(message = "正在加载...") {
    this.content.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #5e35b1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
        <p>${message}</p>
      </div>
    `;
  }
};

// 修改保存到云端功能
document.getElementById('saveToCloudBtn').addEventListener('click', function(e) {
  e.preventDefault();
  
  console.log("保存到云端按钮被点击");
  
  // 隐藏下拉菜单
  document.getElementById('projectDropdown').classList.remove('show');
  
  // 检查是否已登录
  const userId = localStorage.getItem('userId');
  const token = localStorage.getItem('eda_token');
  
  // 验证用户登录状态
  if (!userId || !token) {
    console.log("未找到用户信息或令牌，需要登录");
    showLoginRequiredDialog();
    return;
  }
  
  // 主动尝试刷新令牌，然后再进行保存操作
  console.log("主动尝试刷新令牌");
  
  // 检查是否有保存的登录信息
  const savedUsername = localStorage.getItem('saved_username');
  const savedPassword = localStorage.getItem('saved_password');
  
  if (savedUsername && savedPassword) {
    try {
      // 解码密码
      const decodedPassword = atob(savedPassword);
      
      // 尝试自动重新登录以刷新令牌
      API.login({
        username: savedUsername,
        password: decodedPassword,
        rememberMe: true
      })
      .then(loginResponse => {
        console.log("自动刷新令牌结果:", loginResponse);
        if (loginResponse.code === 200) {
          // 刷新令牌成功，继续保存操作
          console.log("令牌刷新成功，继续保存操作");
          getAndSaveCircuitDataGWT();
        } else {
          console.log("自动登录失败，尝试使用当前令牌");
          // 尝试使用当前令牌验证
          validateTokenAndSave();
        }
      })
      .catch(loginError => {
        console.error("自动登录失败:", loginError);
        // 尝试使用当前令牌验证
        validateTokenAndSave();
      });
    } catch (decodeError) {
      console.error("解码密码失败:", decodeError);
      // 尝试使用当前令牌验证
      validateTokenAndSave();
    }
  } else {
    // 无法自动登录，尝试使用当前令牌验证
    console.log("没有保存的登录信息，尝试使用当前令牌");
    validateTokenAndSave();
  }
  
  // 使用当前令牌进行验证
  function validateTokenAndSave() {
    API.validateToken()
      .then(response => {
        console.log("验证令牌结果:", response);
        if (response.code === 200) {
          // 令牌有效，继续保存操作
          getAndSaveCircuitDataGWT();
        } else {
          console.log("令牌无效，提示用户重新登录");
          showLoginRequiredDialog();
        }
      })
      .catch(error => {
        console.error("验证令牌失败:", error);
        showLoginRequiredDialog();
      });
  }
});

// GWT兼容的获取电路数据并保存
function getAndSaveCircuitDataGWT() {
  try {
    console.log("开始获取电路数据并准备保存...");
    
    // 先清理可能已经存在的文本区域
    const existingTextArea = document.getElementById("circuit-data-textarea");
    if (existingTextArea) {
      console.log("发现已存在的文本区域，先移除");
      document.body.removeChild(existingTextArea);
    }
    
    // 清理可能存在的多余文本区域
    document.querySelectorAll('textarea[style*="opacity: 0"]').forEach(elem => {
      if (elem !== existingTextArea) {
        console.log("发现多余的隐藏文本区域，移除");
        elem.parentNode.removeChild(elem);
      }
    });
    
    // 创建一个隐藏的文本区域
    let textArea = document.createElement("textarea");
    textArea.id = "circuit-data-textarea";
    textArea.style.position = "fixed";
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.width = "2em";
    textArea.style.height = "2em";
    textArea.style.opacity = 0;
    document.body.appendChild(textArea);
    
    // 重置全局变量
    circuitTextData = null;
    
    // 打开加载对话框
    GWTDialog.open({
      title: "保存项目",
      content: "",
      buttons: []
    });
    GWTDialog.showLoading("正在获取电路数据...");
    
    // 尝试获取电路数据
    getCircuitData(function(data) {
      try {
        console.log("获取电路数据结果:", data ? "成功，数据长度=" + data.length : "失败");
        
        // 无论成功与否，都清理临时DOM元素
        const tempTextArea = document.getElementById("circuit-data-textarea");
        if (tempTextArea) {
          document.body.removeChild(tempTextArea);
        }
        
        if (data) {
          // 存储电路数据到全局变量
          window.currentCircuitData = data;
          
          // 显示项目保存对话框
          showGWTProjectSaveDialog();
        } else {
          GWTDialog.close();
          showPromptDialog("无法获取电路数据。请尝试使用'文件->导出为文本'手动保存。");
        }
      } catch (innerError) {
        console.error("处理电路数据时出错:", innerError);
        GWTDialog.close();
        showPromptDialog("处理电路数据时出错: " + innerError.message);
        
        // 确保清理临时DOM元素
        const tempTextArea = document.getElementById("circuit-data-textarea");
        if (tempTextArea) {
          document.body.removeChild(tempTextArea);
        }
      }
    });
  } catch (outerError) {
    console.error("准备获取电路数据时出错:", outerError);
    GWTDialog.close();
    showPromptDialog("准备获取电路数据时出错: " + outerError.message);
    
    // 确保清理临时DOM元素
    const tempTextArea = document.getElementById("circuit-data-textarea");
    if (tempTextArea) {
      document.body.removeChild(tempTextArea);
    }
  }
}

// 显示GWT兼容的项目保存对话框
function showGWTProjectSaveDialog() {
  console.log("显示GWT兼容的项目保存对话框");
  
  const userId = localStorage.getItem('userId');
  if (!userId) {
    GWTDialog.close();
    showLoginRequiredDialog();
    return;
  }
  
  GWTDialog.showLoading("正在加载项目列表...");
  
  // 添加超时保护
  let projectListTimeout = setTimeout(() => {
    console.error("获取项目列表超时");
    GWTDialog.close();
    showPromptDialog("加载项目列表超时，请重试");
  }, 15000);
  
  // 获取用户项目列表
  API.getUserCircuits(userId)
    .then(response => {
      console.log("获取到项目列表响应:", response);
      
      // 清除超时
      clearTimeout(projectListTimeout);
      
      const hasProjects = response.code === 200 && response.data && response.data.length > 0;
      const defaultName = "我的电路 " + new Date().toLocaleString();
      
      // 创建内容元素
      const contentElement = document.createElement('div');
      
      // 添加选项卡
      const tabsElement = document.createElement('div');
      tabsElement.style.display = 'flex';
      tabsElement.style.marginBottom = '15px';
      tabsElement.style.borderBottom = '1px solid #eee';
      tabsElement.style.paddingBottom = '10px';
      
      const projectsTab = document.createElement('button');
      projectsTab.textContent = '我的项目';
      projectsTab.className = hasProjects ? 'gwt-btn gwt-btn-primary' : 'gwt-btn gwt-btn-secondary';
      projectsTab.style.flex = '1';
      projectsTab.style.marginRight = '5px';
      
      const newProjectTab = document.createElement('button');
      newProjectTab.textContent = '新建项目';
      newProjectTab.className = hasProjects ? 'gwt-btn gwt-btn-secondary' : 'gwt-btn gwt-btn-primary';
      newProjectTab.style.flex = '1';
      newProjectTab.style.marginLeft = '5px';
      
      tabsElement.appendChild(projectsTab);
      tabsElement.appendChild(newProjectTab);
      contentElement.appendChild(tabsElement);
      
      // 添加项目列表部分
      const projectsSection = document.createElement('div');
      projectsSection.id = 'gwt-projects-section';
      projectsSection.style.display = hasProjects ? 'block' : 'none';
      
      if (hasProjects) {
        const projectsTitle = document.createElement('h4');
        projectsTitle.textContent = '选择要覆盖的项目';
        projectsTitle.style.margin = '0 0 10px';
        projectsTitle.style.fontSize = '16px';
        projectsTitle.style.color = '#444';
        projectsSection.appendChild(projectsTitle);
        
        const projectsList = document.createElement('div');
        projectsList.style.maxHeight = '300px';
        projectsList.style.overflowY = 'auto';
        projectsList.style.marginBottom = '15px';
        projectsList.style.border = '1px solid #eee';
        projectsList.style.borderRadius = '8px';
        
        // 存储项目数据到全局变量
        window.projectsList = response.data;
        
        // 添加项目列表项
        response.data.forEach((circuit, index) => {
          const projectItem = document.createElement('div');
          projectItem.className = 'gwt-project-item';
          projectItem.dataset.id = circuit.circuitId;
          projectItem.dataset.index = index;
          
          const projectName = document.createElement('div');
          projectName.style.fontWeight = '500';
          projectName.style.marginBottom = '3px';
          projectName.textContent = circuit.circuitName;
          
          const projectDate = document.createElement('div');
          projectDate.style.fontSize = '12px';
          projectDate.style.color = '#888';
          projectDate.textContent = new Date(circuit.updateTime || circuit.createTime).toLocaleString();
          
          projectItem.appendChild(projectName);
          projectItem.appendChild(projectDate);
          
          // 绑定点击事件
          projectItem.onclick = function() {
            document.querySelectorAll('.gwt-project-item').forEach(item => {
              item.classList.remove('selected');
            });
            this.classList.add('selected');
            window.selectedProjectIndex = index;
          };
          
          projectsList.appendChild(projectItem);
        });
        
        projectsSection.appendChild(projectsList);
      } else {
        const noProjects = document.createElement('p');
        noProjects.textContent = '您还没有保存过项目';
        noProjects.style.textAlign = 'center';
        noProjects.style.color = '#666';
        noProjects.style.margin = '15px 0';
        projectsSection.appendChild(noProjects);
      }
      
      contentElement.appendChild(projectsSection);
      
      // 添加新建项目部分
      const newProjectSection = document.createElement('div');
      newProjectSection.id = 'gwt-new-project-section';
      newProjectSection.style.display = hasProjects ? 'none' : 'block';
      
      const newProjectTitle = document.createElement('h4');
      newProjectTitle.textContent = '创建新项目';
      newProjectTitle.style.margin = '0 0 10px';
      newProjectTitle.style.fontSize = '16px';
      newProjectTitle.style.color = '#444';
      newProjectSection.appendChild(newProjectTitle);
      
      // 项目名称
      const nameGroup = document.createElement('div');
      nameGroup.style.marginBottom = '10px';
      
      const nameLabel = document.createElement('label');
      nameLabel.textContent = '项目名称:';
      nameLabel.style.display = 'block';
      nameLabel.style.marginBottom = '5px';
      nameLabel.style.fontSize = '14px';
      
      const nameInput = document.createElement('input');
      nameInput.id = 'gwt-new-project-name';
      nameInput.type = 'text';
      nameInput.value = defaultName;
      nameInput.style.width = '100%';
      nameInput.style.padding = '8px';
      nameInput.style.boxSizing = 'border-box';
      nameInput.style.borderRadius = '4px';
      nameInput.style.border = '1px solid #ccc';
      
      nameGroup.appendChild(nameLabel);
      nameGroup.appendChild(nameInput);
      newProjectSection.appendChild(nameGroup);
      
      // 项目描述
      const descGroup = document.createElement('div');
      descGroup.style.marginBottom = '10px';
      
      const descLabel = document.createElement('label');
      descLabel.textContent = '描述 (可选):';
      descLabel.style.display = 'block';
      descLabel.style.marginBottom = '5px';
      descLabel.style.fontSize = '14px';
      
      const descInput = document.createElement('textarea');
      descInput.id = 'gwt-new-project-desc';
      descInput.style.width = '100%';
      descInput.style.padding = '8px';
      descInput.style.boxSizing = 'border-box';
      descInput.style.borderRadius = '4px';
      descInput.style.border = '1px solid #ccc';
      descInput.style.minHeight = '60px';
      descInput.style.resize = 'vertical';
      
      descGroup.appendChild(descLabel);
      descGroup.appendChild(descInput);
      newProjectSection.appendChild(descGroup);
      
      // 是否公开
      const publicGroup = document.createElement('div');
      publicGroup.style.marginBottom = '10px';
      
      const publicLabel = document.createElement('label');
      publicLabel.style.display = 'flex';
      publicLabel.style.alignItems = 'center';
      publicLabel.style.fontSize = '14px';
      
      const publicCheckbox = document.createElement('input');
      publicCheckbox.id = 'gwt-new-project-public';
      publicCheckbox.type = 'checkbox';
      
      const publicText = document.createElement('span');
      publicText.textContent = '公开此项目（允许其他用户查看）';
      publicText.style.marginLeft = '5px';
      
      publicLabel.appendChild(publicCheckbox);
      publicLabel.appendChild(publicText);
      publicGroup.appendChild(publicLabel);
      newProjectSection.appendChild(publicGroup);
      
      contentElement.appendChild(newProjectSection);
      
      // 设置选项卡切换事件
      projectsTab.onclick = function() {
        if (hasProjects) {
          projectsSection.style.display = 'block';
          newProjectSection.style.display = 'none';
          projectsTab.className = 'gwt-btn gwt-btn-primary';
          newProjectTab.className = 'gwt-btn gwt-btn-secondary';
        }
      };
      
      newProjectTab.onclick = function() {
        projectsSection.style.display = 'none';
        newProjectSection.style.display = 'block';
        projectsTab.className = 'gwt-btn gwt-btn-secondary';
        newProjectTab.className = 'gwt-btn gwt-btn-primary';
      };
      
      // 更新对话框内容
      GWTDialog.open({
        title: "保存项目",
        content: contentElement,
        buttons: [
          { 
            text: "取消", 
            primary: false, 
            onClick: () => GWTDialog.close() 
          },
          { 
            text: "保存", 
            primary: true, 
            onClick: () => {
              const circuitData = window.currentCircuitData;
              
              if (!circuitData) {
                showPromptDialog('电路数据丢失，请重试');
                GWTDialog.close();
                return;
              }
              
              // 判断是覆盖还是新建
              if (projectsSection.style.display === 'block' && hasProjects) {
                // 覆盖现有项目
                const selectedItem = document.querySelector('.gwt-project-item.selected');
                const selectedProjectIndex = window.selectedProjectIndex;
                
                if (selectedItem && typeof selectedProjectIndex !== 'undefined' && window.projectsList) {
                  const selectedCircuit = window.projectsList[selectedProjectIndex];
                  if (selectedCircuit) {
                    console.log("覆盖现有项目:", selectedCircuit.circuitName);
                    GWTDialog.close();
                    saveCircuit({
                      circuitId: selectedCircuit.circuitId,
                      userId: parseInt(userId),
                      circuitName: selectedCircuit.circuitName,
                      circuitData: circuitData,
                      description: selectedCircuit.description,
                      isPublic: selectedCircuit.isPublic
                    });
                  } else {
                    showPromptDialog('请选择要覆盖的项目或创建新项目');
                    return;
                  }
                } else {
                  showPromptDialog('请选择要覆盖的项目或创建新项目');
                  return;
                }
              } else {
                // 新建项目
                const nameInput = document.getElementById('gwt-new-project-name');
                const descInput = document.getElementById('gwt-new-project-desc');
                const publicCheckbox = document.getElementById('gwt-new-project-public');
                
                if (!nameInput || !nameInput.value.trim()) {
                  showPromptDialog('请输入项目名称');
                  return;
                }
                
                console.log("创建新项目:", nameInput.value.trim());
                GWTDialog.close();
                saveCircuit({
                  userId: parseInt(userId),
                  circuitName: nameInput.value.trim(),
                  circuitData: circuitData,
                  description: descInput ? descInput.value.trim() : '',
                  isPublic: publicCheckbox && publicCheckbox.checked ? '1' : '0'
                });
              }
            }
          }
        ]
      });
    })
    .catch(error => {
      console.error("加载项目列表失败:", error);
      
      // 清除超时
      clearTimeout(projectListTimeout);
      
      // 检查是否是认证错误
      if (error.message && (error.message.includes('401') || error.message.includes('JWT'))) {
        console.log("认证错误，尝试重新登录");
        GWTDialog.close();
        showAutoLoginDialog();
        return;
      }
      
      // 显示错误但仍允许创建新项目
      const errorContent = document.createElement('div');
      
      const errorMessage = document.createElement('p');
      errorMessage.textContent = '加载项目列表失败: ' + error.message;
      errorMessage.style.color = '#f44336';
      errorMessage.style.textAlign = 'center';
      errorMessage.style.marginBottom = '15px';
      errorContent.appendChild(errorMessage);
      
      // 添加新建项目表单
      const defaultName = "我的电路 " + new Date().toLocaleString();
      
      const nameGroup = document.createElement('div');
      nameGroup.style.marginBottom = '10px';
      
      const nameLabel = document.createElement('label');
      nameLabel.textContent = '项目名称:';
      nameLabel.style.display = 'block';
      nameLabel.style.marginBottom = '5px';
      nameLabel.style.fontSize = '14px';
      
      const nameInput = document.createElement('input');
      nameInput.id = 'gwt-new-project-name';
      nameInput.type = 'text';
      nameInput.value = defaultName;
      nameInput.style.width = '100%';
      nameInput.style.padding = '8px';
      nameInput.style.boxSizing = 'border-box';
      nameInput.style.borderRadius = '4px';
      nameInput.style.border = '1px solid #ccc';
      
      nameGroup.appendChild(nameLabel);
      nameGroup.appendChild(nameInput);
      errorContent.appendChild(nameGroup);
      
      const descGroup = document.createElement('div');
      descGroup.style.marginBottom = '10px';
      
      const descLabel = document.createElement('label');
      descLabel.textContent = '描述 (可选):';
      descLabel.style.display = 'block';
      descLabel.style.marginBottom = '5px';
      descLabel.style.fontSize = '14px';
      
      const descInput = document.createElement('textarea');
      descInput.id = 'gwt-new-project-desc';
      descInput.style.width = '100%';
      descInput.style.padding = '8px';
      descInput.style.boxSizing = 'border-box';
      descInput.style.borderRadius = '4px';
      descInput.style.border = '1px solid #ccc';
      descInput.style.minHeight = '60px';
      descInput.style.resize = 'vertical';
      
      descGroup.appendChild(descLabel);
      descGroup.appendChild(descInput);
      errorContent.appendChild(descGroup);
      
      const publicGroup = document.createElement('div');
      publicGroup.style.marginBottom = '10px';
      
      const publicLabel = document.createElement('label');
      publicLabel.style.display = 'flex';
      publicLabel.style.alignItems = 'center';
      publicLabel.style.fontSize = '14px';
      
      const publicCheckbox = document.createElement('input');
      publicCheckbox.id = 'gwt-new-project-public';
      publicCheckbox.type = 'checkbox';
      
      const publicText = document.createElement('span');
      publicText.textContent = '公开此项目（允许其他用户查看）';
      publicText.style.marginLeft = '5px';
      
      publicLabel.appendChild(publicCheckbox);
      publicLabel.appendChild(publicText);
      publicGroup.appendChild(publicLabel);
      errorContent.appendChild(publicGroup);
      
      // 更新对话框
      GWTDialog.open({
        title: "保存项目",
        content: errorContent,
        buttons: [
          { 
            text: "取消", 
            primary: false, 
            onClick: () => GWTDialog.close() 
          },
          { 
            text: "保存", 
            primary: true, 
            onClick: () => {
              const circuitData = window.currentCircuitData;
              
              if (!circuitData) {
                showPromptDialog('电路数据丢失，请重试');
                GWTDialog.close();
                return;
              }
              
              const nameInput = document.getElementById('gwt-new-project-name');
              const descInput = document.getElementById('gwt-new-project-desc');
              const publicCheckbox = document.getElementById('gwt-new-project-public');
              
              if (!nameInput || !nameInput.value.trim()) {
                showPromptDialog('请输入项目名称');
                return;
              }
              
              // 先关闭对话框，然后再保存
              GWTDialog.close();
              saveCircuit({
                userId: parseInt(userId),
                circuitName: nameInput.value.trim(),
                circuitData: circuitData,
                description: descInput ? descInput.value.trim() : '',
                isPublic: publicCheckbox && publicCheckbox.checked ? '1' : '0'
              });
            }
          }
        ]
      });
    });
}
</script>

  </body>
 </html>
